#!/usr/bin/with-contenv bashio
set -e

# Exporta desde /data/options.json a ENV para tu Python
export INVERTER_IP="$(bashio::config 'inverter_ip')"
export MQTT_HOST="$(bashio::config 'mqtt_host')"
export MQTT_USERNAME="$(bashio::config 'mqtt_username')"
export MQTT_PASSWORD="$(bashio::config 'mqtt_password')"
export MQTT_PORT="$(bashio::config 'mqtt_port')"
export MODBUS_SLAVE_ID="$(bashio::config 'modbus_slave_id')"
export MODBUS_PORT="$(bashio::config 'modbus_port')"
export MQTT_QOS="$(bashio::config 'mqtt_qos')"
export MQTT_CLIENT_ID="$(bashio::config 'mqtt_client_id')"

# Opcionales (si los tienes en el schema)
if bashio::config.has 'mqtt_protocol'; then
  export MQTT_PROTOCOL="$(bashio::config 'mqtt_protocol')"   # "311" o "5"
fi
if bashio::config.has 'mqtt_tls'; then
  export MQTT_TLS="$(bashio::config 'mqtt_tls')"             # true/false
fi
if bashio::config.has 'mqtt_keepalive'; then
  export MQTT_KEEPALIVE="$(bashio::config 'mqtt_keepalive')"
fi

# Lanzar tu app
exec /opt/venv/bin/python -u /app/huawei_mqtt.py